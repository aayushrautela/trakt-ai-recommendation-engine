{% extends "base.html" %}

{% block content %}
<div class="card">
    <h1>Trakt AI List Generator</h1>
    <p>Generate personalized movie recommendations based on your Trakt watch history using AI.</p>
    
    {% if not session.username %}
    <div class="status">
        <p>Please log in with your Trakt account to get started.</p>
        <a href="/login" class="login-btn">Login with Trakt</a>
    </div>
    {% else %}
    <p>Welcome, <strong>{{ session.username }}</strong>!</p>
    
    <form id="recommendationForm" action="/api/generate-list" method="POST">
        <div class="form-group">
            <label for="time_period">Time Period:</label>
            <select id="time_period" name="time_period" required>
                <option value="1 day">Last 1 day</option>
                <option value="1 week" selected>Last 1 week</option>
                <option value="1 month">Last 1 month</option>
                <option value="3 months">Last 3 months</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="genres">Genres (optional):</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="action" name="genres" value="action">
                    <label for="action">Action</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="adventure" name="genres" value="adventure">
                    <label for="adventure">Adventure</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="comedy" name="genres" value="comedy">
                    <label for="comedy">Comedy</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="drama" name="genres" value="drama">
                    <label for="drama">Drama</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="horror" name="genres" value="horror">
                    <label for="horror">Horror</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="romance" name="genres" value="romance">
                    <label for="romance">Romance</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="thriller" name="genres" value="thriller">
                    <label for="thriller">Thriller</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="science fiction" name="genres" value="science fiction">
                    <label for="science fiction">Sci-Fi</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="fantasy" name="genres" value="fantasy">
                    <label for="fantasy">Fantasy</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="animation" name="genres" value="animation">
                    <label for="animation">Animation</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="list_name">List Name:</label>
            <input type="text" id="list_name" name="list_name" value="AI Recommendations" required>
        </div>
        
        <button type="submit" class="btn" id="generateBtn">
            Generate Recommendations
        </button>
    </form>
    
    <div id="status" style="display: none;" class="status">
        <div class="loading"></div>
        <span>Generating your personalized recommendations...</span>
    </div>
    
    <div id="result" style="display: none;"></div>
    
    {% endif %}
</div>

{% if session.username %}
<script>
document.getElementById('recommendationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Show loading status
    document.getElementById('status').style.display = 'block';
    document.getElementById('result').style.display = 'none';
    document.getElementById('generateBtn').disabled = true;
    
    // Collect form data
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Convert genres array
    const genres = formData.getAll('genres');
    data.genres = genres;
    
    // Make API call
    fetch('/api/generate-list', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        document.getElementById('status').style.display = 'none';
        
        if (result.success) {
            document.getElementById('result').innerHTML = `
                <div class="status success">
                    <h3>✅ Recommendations Generated!</h3>
                    <div class="list-link">
                        <p>Your personalized list has been created:</p>
                        <a href="${result.list_url}" target="_blank">${result.list_name}</a>
                    </div>
                    <p><small>This list will be automatically updated every night with fresh recommendations.</small></p>
                </div>
            `;
        } else {
            document.getElementById('result').innerHTML = `
                <div class="status error">
                    <h3>❌ Error</h3>
                    <p>${result.error}</p>
                </div>
            `;
        }
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('generateBtn').disabled = false;
    })
    .catch(error => {
        document.getElementById('status').style.display = 'none';
        document.getElementById('result').innerHTML = `
            <div class="status error">
                <h3>❌ Error</h3>
                <p>Something went wrong. Please try again.</p>
            </div>
        `;
        document.getElementById('result').style.display = 'block';
        document.getElementById('generateBtn').disabled = false;
    });
});
</script>
{% endif %}
{% endblock %}
