{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <div class="header-content">
            <h1>My AI Movie Lists</h1>
            <p>Manage your personalized movie recommendation lists</p>
        </div>
        <button id="createListBtn" class="btn btn-primary">
            <span>+</span> Create New List
        </button>
    </div>
    
    <div id="listsContainer" class="lists-container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <span>Loading your lists...</span>
        </div>
    </div>
    
    <!-- Full Screen Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">Processing...</h3>
            <p id="loadingMessage">Please wait while we process your request</p>
        </div>
    </div>
    
    <!-- Create/Edit List Modal -->
    <div id="listModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Create New List</h2>
                    <button class="modal-close" id="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="listForm">
                        <div class="form-group">
                            <label for="list_name">List Name</label>
                            <input type="text" id="list_name" name="list_name" placeholder="e.g., Weekend Movies" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="time_period">Time Period</label>
                            <select id="time_period" name="time_period" required>
                                <option value="1 day">Last 1 day</option>
                                <option value="1 week" selected>Last 1 week</option>
                                <option value="1 month">Last 1 month</option>
                                <option value="3 months">Last 3 months</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="genres">Genres (optional)</label>
                            <div class="checkbox-grid">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="action" name="genres" value="action">
                                    <label for="action">Action</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="adventure" name="genres" value="adventure">
                                    <label for="adventure">Adventure</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="comedy" name="genres" value="comedy">
                                    <label for="comedy">Comedy</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="drama" name="genres" value="drama">
                                    <label for="drama">Drama</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="horror" name="genres" value="horror">
                                    <label for="horror">Horror</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="romance" name="genres" value="romance">
                                    <label for="romance">Romance</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="thriller" name="genres" value="thriller">
                                    <label for="thriller">Thriller</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="science fiction" name="genres" value="science fiction">
                                    <label for="science fiction">Sci-Fi</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="fantasy" name="genres" value="fantasy">
                                    <label for="fantasy">Fantasy</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="animation" name="genres" value="animation">
                                    <label for="animation">Animation</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create List</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentEditingList = null;

// Load user lists on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUserLists();
    
    // Modal event listeners
    document.getElementById('createListBtn').addEventListener('click', openCreateModal);
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('listForm').addEventListener('submit', handleFormSubmit);
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('listModal');
        if (event.target === modal) {
            closeModal();
        }
    });
});

function loadUserLists() {
    showLoading('Loading your lists...', 'Fetching your movie recommendation lists');
    
    fetch('/api/lists')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                displayLists(data.lists);
            } else {
                showError('Failed to load lists: ' + data.error);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error loading lists: ' + error.message);
        });
}

function displayLists(lists) {
    const container = document.getElementById('listsContainer');
    
    if (lists.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>No lists yet</h3>
                <p>Create your first AI-powered movie list to get started!</p>
                <button class="btn btn-primary" onclick="openCreateModal()">Create Your First List</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = lists.map(list => `
        <div class="list-card">
            <div class="list-header">
                <h3>${list.name}</h3>
                <div class="list-actions">
                    <button class="btn btn-sm btn-secondary" onclick="editList('${list.name}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteList('${list.name}')">Delete</button>
                </div>
            </div>
            <div class="list-details">
                <p><strong>Time Period:</strong> ${list.config.time_period}</p>
                <p><strong>Genres:</strong> ${list.config.genres.length > 0 ? list.config.genres.join(', ') : 'All genres'}</p>
                <p><strong>Last Updated:</strong> Auto-updated nightly</p>
            </div>
            <div class="list-footer">
                <a href="${list.list_url}" target="_blank" class="btn btn-primary">View on Trakt</a>
            </div>
        </div>
    `).join('');
}

function openCreateModal() {
    currentEditingList = null;
    document.getElementById('modalTitle').textContent = 'Create New List';
    document.getElementById('listForm').reset();
    document.getElementById('listModal').style.display = 'flex';
}

function editList(listName) {
    currentEditingList = listName;
    document.getElementById('modalTitle').textContent = 'Edit List';
    document.getElementById('submitBtn').textContent = 'Update List';
    
    // Load list details
    fetch(`/api/lists/${encodeURIComponent(listName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('list_name').value = data.config.list_name;
                document.getElementById('time_period').value = data.config.time_period;
                
                // Set genres
                document.querySelectorAll('input[name="genres"]').forEach(checkbox => {
                    checkbox.checked = data.config.genres.includes(checkbox.value);
                });
                
                document.getElementById('listModal').style.display = 'flex';
            } else {
                showError('Failed to load list details: ' + data.error);
            }
        })
        .catch(error => {
            showError('Error loading list details: ' + error.message);
        });
}

function closeModal() {
    document.getElementById('listModal').style.display = 'none';
    currentEditingList = null;
}

function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    data.genres = formData.getAll('genres');
    
    const isEditing = currentEditingList !== null;
    const url = isEditing ? 
        `/api/lists/${encodeURIComponent(currentEditingList)}` : 
        '/api/generate-list';
    const method = isEditing ? 'PUT' : 'POST';
    
    showLoading(
        isEditing ? 'Updating list...' : 'Creating list...',
        isEditing ? 'Updating your movie list' : 'Generating AI recommendations for your new list'
    );
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        hideLoading();
        if (result.success) {
            closeModal();
            loadUserLists(); // Refresh the lists
            showSuccess(isEditing ? 'List updated successfully!' : 'List created successfully!');
        } else {
            showError(result.error);
        }
    })
    .catch(error => {
        hideLoading();
        showError('Error: ' + error.message);
    });
}

function deleteList(listName) {
    if (!confirm(`Are you sure you want to delete "${listName}"? This action cannot be undone.`)) {
        return;
    }
    
    showLoading('Deleting list...', 'Removing list from Trakt and clearing configuration');
    
    fetch(`/api/lists/${encodeURIComponent(listName)}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        hideLoading();
        if (result.success) {
            loadUserLists(); // Refresh the lists
            showSuccess('List deleted successfully!');
        } else {
            showError(result.error);
        }
    })
    .catch(error => {
        hideLoading();
        showError('Error deleting list: ' + error.message);
    });
}

function showSuccess(message) {
    // You can implement a toast notification here
    alert(message);
}

function showError(message) {
    // You can implement a toast notification here
    alert('Error: ' + message);
}

// Loading overlay functions
function showLoading(title, message) {
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}
</script>
{% endblock %}
